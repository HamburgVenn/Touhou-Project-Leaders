
namespace = touhou_war_in_heaven

country_event = {
    id = touhou_war_in_heaven.4
    title = touhou_war_in_heaven.4.name
    desc = {
        text = touhou_war_in_heaven.4.fallen
        trigger = {
            has_global_flag = moriya_war_in_heaven_vs_fallen
        }
    }
    desc = {
        text = touhou_war_in_heaven.4.awakened
        trigger = {
            has_global_flag = moriya_war_in_heaven_vs_awakened
        }
    }
    picture = {
        trigger = {
            event_target:moriya_wih_defender = {
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }
    picture = {
        trigger = {
            event_target:moriya_wih_defender = {
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }

    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    option = {
        name = touhou_war_in_heaven.4.a
        trigger = {
            has_been_declared_crisis = no
            is_subject = no
            NOT = {
                any_country = {
                    OR = {
                        is_same_value = event_target:moriya_wih_attacker
                        is_same_value = event_target:moriya_wih_defender
                    }
                    is_at_war_with = prev
                }
            }
            is_country_type = default
        }
        ai_chance = {
            factor = 100
            modifier = {
                factor = 100
                event_target:moriya_wih_attacker = {
                    is_galactic_emperor = yes
                }
                is_galactic_community_member = yes
            }
            modifier = {
                factor = 100
                is_in_federation_with = event_target:moriya_wih_attacker
            }
            modifier = {
                factor = 10
                event_target:moriya_wih_attacker = {
                    is_galactic_custodian = yes
                }
                is_galactic_community_member = yes
            }
            modifier = {
                factor = 0
                OR = {
                    is_homicidal = yes
                    is_level_4_player_crisis = yes
                    is_level_5_player_crisis = yes
                }
            }
            modifier = {
                factor = 5
                any_neighbor_country = {
                    is_same_empire = event_target:moriya_wih_attacker
                }
            }
            modifier = {
                factor = 2
                NOT = {
                    any_neighbor_country = {
                        is_same_empire = event_target:moriya_wih_attacker
                    }
                }
                any_system_within_border = {
                    distance_to_empire = {
                        who = event_target:moriya_wih_attacker
                        distance <= 2
                        use_bypasses = no
                        type = hyperlane
                    }
                }
            }
            modifier = {
                factor = 5
                is_friendly_to = event_target:moriya_wih_attacker
            }
            modifier = {
                factor = 2
                is_cordial_to = event_target:moriya_wih_attacker
            }
            modifier = {
                factor = 0.2
                OR = {
                    is_threatened_to = event_target:moriya_wih_attacker
                    is_unfriendly_to = event_target:moriya_wih_attacker
                }
            }
            modifier = {
                factor = 0.1
                OR = {
                    is_hostile_to = event_target:moriya_wih_attacker
                    is_domineering_to = event_target:moriya_wih_attacker
                }
            }
            modifier = {
                factor = 0
                is_rival = event_target:moriya_wih_attacker
            }
            modifier = {
                factor = 0.5
                OR = {
                    event_target:moriya_wih_attacker = {
                        is_spiritualist = yes
                        root = {
                            NOR = {
                                has_ethic = ethic_spiritualist
                                has_ethic = ethic_fanatic_spiritualist
                            }
                        }
                    }
                    event_target:moriya_wih_attacker = {
                        is_materialist = yes
                        root = {
                            NOR = {
                                has_ethic = ethic_materialist
                                has_ethic = ethic_fanatic_materialist
                            }
                        }
                    }
                }
            }
            modifier = {
                factor = 0.2
                OR = {
                    event_target:moriya_wih_attacker = {
                        is_spiritualist = yes
                        root = {
                            has_ethic = ethic_materialist
                        }
                    }
                    event_target:moriya_wih_attacker = {
                        is_materialist = yes
                        root = {
                            has_ethic = ethic_spiritualist
                        }
                    }
                }
            }
            modifier = {
                factor = 0.1
                OR = {
                    event_target:moriya_wih_attacker = {
                        is_spiritualist = yes
                        root = {
                            has_ethic = ethic_fanatic_materialist
                        }
                    }
                    event_target:moriya_wih_attacker = {
                        is_materialist = yes
                        root = {
                            has_ethic = ethic_fanatic_spiritualist
                        }
                    }
                }
            }
        }
        hidden_effect = { set_country_flag = war_in_heaven_picked_side }
        if = {
            limit = {
                is_megacorp = yes
            }
            force_add_civic = civic_moriya_shinto_corp
        }
        else_if = {
            limit = {
                is_gestalt = no
            }
            force_add_civic = civic_moriya_shinto
        }
        if = {
            limit = {
                event_target:moriya_wih_attacker = {
                    is_materialist = yes
                }
            }
            shift_ethic = ethic_fanatic_materialist
        }
        if = {
            limit = {
                event_target:moriya_wih_attacker = {
                    is_spiritualist = yes
                }
            }
            shift_ethic = ethic_fanatic_spiritualist
        }
        custom_tooltip = touhou_war_in_heaven.4.a.tt
        hidden_effect = {
            event_target:moriya_wih_attacker = {
                switch = {
                    trigger = has_policy_flag
                    oppressive_terms = {
                        if = {
                            limit = {
                                event_target:moriya_wih_attacker = { is_ai = yes }
                            }
                            Root = {
                                set_subject_of = {
                                    who = event_target:moriya_wih_attacker
                                    preset = preset_vassal_oppressive_ai
                                }
                            }
                        }
                        else = {
                            Root = {
                                set_subject_of = {
                                    who = event_target:moriya_wih_attacker
                                    preset = preset_vassal_oppressive
                                }
                            }
                        }
                    }
                    balanced_terms = {
                        Root = {
                            set_subject_of = {
                                who = event_target:moriya_wih_attacker
                                preset = preset_vassal_balanced
                            }
                        }
                    }
                    benevolent_terms = {
                        Root = {
                            set_subject_of = {
                                who = event_target:moriya_wih_attacker
                                preset = preset_vassal_benevolent
                            }
                        }
                    }
                }
            }
        }
        hidden_effect = {
            hidden_effect = { add_opinion_modifier = { who = event_target:moriya_wih_attacker modifier = opinion_war_in_heaven_ally } }
            event_target:moriya_wih_attacker = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_ally } }
            hidden_effect = { add_opinion_modifier = { who = event_target:moriya_wih_defender modifier = opinion_war_in_heaven_enemy } }
            event_target:moriya_wih_defender = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_enemy } }
        }
        join_war = event_target:moriya_wih_attacker
    }
    option = {
        name = touhou_war_in_heaven.4.b
        trigger = {
            has_been_declared_crisis = no
            is_subject = no
            NOT = {
                any_country = {
                    OR = {
                        is_same_value = event_target:moriya_wih_attacker
                        is_same_value = event_target:moriya_wih_defender
                    }
                    is_at_war_with = prev
                }
            }
            NOR = {
                has_civic = civic_moriya_shinto
                has_civic = civic_moriya_shinto_corp
                is_in_federation_with = event_target:moriya_wih_attacker
            }
            is_country_type = default
        }
        ai_chance = {
            factor = 100
            modifier = {
                factor = 0
                OR = {
                    is_homicidal = yes
                    is_level_4_player_crisis = yes
                    is_level_5_player_crisis = yes
                }
            }
            modifier = {
                factor = 5
                any_neighbor_country = {
                    is_same_empire = event_target:moriya_wih_defender
                }
            }
            modifier = {
                factor = 5
                is_threatened_to = event_target:moriya_wih_attacker
            }
            modifier = {
                factor = 2
                NOT = {
                    any_neighbor_country = {
                        is_same_empire = event_target:moriya_wih_defender
                    }
                }
                any_system_within_border = {
                    distance_to_empire = {
                        who = event_target:moriya_wih_defender
                        distance <= 2
                        use_bypasses = no
                        type = hyperlane
                    }
                }
            }
            modifier = {
                factor = 2
                is_rival = event_target:moriya_wih_attacker
            }
            modifier = {
                factor = 0.2
                OR = {
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_spiritualist
                        root = {
                            NOR = {
                                has_ethic = ethic_spiritualist
                                has_ethic = ethic_fanatic_spiritualist
                            }
                        }
                    }
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_materialist
                        root = {
                            NOR = {
                                has_ethic = ethic_materialist
                                has_ethic = ethic_fanatic_materialist
                            }
                        }
                    }
                }
            }
            modifier = {
                factor = 0.5
                OR = {
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_xenophobe
                        root = {
                            NOR = {
                                has_ethic = ethic_militarist
                                has_ethic = ethic_fanatic_militarist
                                has_ethic = ethic_xenophobe
                                has_ethic = ethic_fanatic_xenophobe
                            }
                        }
                    }
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_xenophile
                        root = {
                            NOR = {
                                has_ethic = ethic_pacifist
                                has_ethic = ethic_fanatic_pacifist
                                has_ethic = ethic_xenophile
                                has_ethic = ethic_fanatic_xenophile
                            }
                        }
                    }
                    event_target:moriya_wih_defender = {
                        is_hive_empire = yes
                        root = {
                            is_hive_empire = no
                        }
                    }
                    event_target:moriya_wih_defender = {
                        has_country_flag = fallen_empire_hive_war
                        root = {
                            is_pacifist = yes
                        }
                    }
                }
            }
            modifier = {
                factor = 0.1
                OR = {
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_xenophobe
                        root = {
                            OR = {
                                has_ethic = ethic_pacifist
                                has_ethic = ethic_fanatic_pacifist
                                has_ethic = ethic_xenophile
                                has_ethic = ethic_fanatic_xenophile
                            }
                        }
                    }
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_xenophile
                        root = {
                            OR = {
                                has_ethic = ethic_militarist
                                has_ethic = ethic_fanatic_militarist
                                has_ethic = ethic_xenophobe
                                has_ethic = ethic_fanatic_xenophobe
                            }
                        }
                    }
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_materialist
                        root = {
                            OR = {
                                has_ethic = ethic_spiritualist
                                has_ethic = ethic_fanatic_spiritualist
                            }
                        }
                    }
                    event_target:moriya_wih_defender = {
                        has_ethic = ethic_fanatic_spiritualist
                        root = {
                            OR = {
                                has_ethic = ethic_materialist
                                has_ethic = ethic_fanatic_materialist
                            }
                        }
                    }
                }
            }
        }
        hidden_effect = { set_country_flag = war_in_heaven_picked_side }
        if = {
            limit = {
                event_target:moriya_wih_defender = {
                    has_ethic = ethic_fanatic_xenophobe
                }
            }
            custom_tooltip = touhou_war_in_heaven.4.b.thrall.tt
            hidden_effect = {
                set_subject_of = {
                    who = event_target:moriya_wih_defender
                    preset = preset_thrall
                }
            }
        }
        if = {
            limit = {
                event_target:moriya_wih_defender = {
                    has_ethic = ethic_fanatic_xenophile
                }
            }
            custom_tooltip = touhou_war_in_heaven.4.b.signatory.tt
            hidden_effect = {
                set_subject_of = {
                    who = event_target:moriya_wih_defender
                    preset = preset_signatory
                }
            }
        }
        if = {
            limit = {
                event_target:moriya_wih_defender = {
                    has_ethic = ethic_fanatic_spiritualist
                }
            }
            custom_tooltip = touhou_war_in_heaven.4.b.dominion.tt
            hidden_effect = {
                set_subject_of = {
                    who = event_target:moriya_wih_defender
                    preset = preset_dominion
                }
                if = {
                    limit = {
                        is_gestalt = no
                    }
                    shift_ethic = ethic_fanatic_spiritualist
                }
            }
        }
        if = {
            limit = {
                event_target:moriya_wih_defender = {
                    has_ethic = ethic_fanatic_materialist
                }
            }
            custom_tooltip = touhou_war_in_heaven.4.b.satellite.tt
            hidden_effect = {
                set_subject_of = {
                    who = event_target:moriya_wih_defender
                    preset = preset_satellite
                }
            }
        }
        if = {
            limit = {
                event_target:moriya_wih_defender = {
                    has_country_flag = fallen_empire_hive_control
                }
            }
            custom_tooltip = touhou_war_in_heaven.4.b.political_client.tt
            hidden_effect = {
                set_subject_of = {
                    who = event_target:moriya_wih_defender
                    preset = preset_political_client
                }
            }
        }
        if = {
            limit = {
                event_target:moriya_wih_defender = {
                    has_country_flag = fallen_empire_hive_war
                }
            }
            custom_tooltip = touhou_war_in_heaven.4.b.herald.tt
            hidden_effect = {
                set_subject_of = {
                    who = event_target:moriya_wih_defender
                    preset = preset_herald
                }
            }
        }
        hidden_effect = {
            hidden_effect = { add_opinion_modifier = { who = event_target:moriya_wih_defender modifier = opinion_war_in_heaven_ally } }
            event_target:moriya_wih_defender = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_ally } }
            hidden_effect = { add_opinion_modifier = { who = event_target:moriya_wih_attacker modifier = opinion_war_in_heaven_enemy } }
            event_target:moriya_wih_attacker = { add_opinion_modifier = { who = root modifier = opinion_war_in_heaven_enemy } }
        }
        join_war = event_target:moriya_wih_defender
    }
    option = {
        name = touhou_war_in_heaven.4.c
        trigger = {
            is_subject = no
            has_been_declared_crisis = no
            NOR = {
                has_civic = civic_moriya_shinto
                has_civic = civic_moriya_shinto_corp
                is_in_federation_with = event_target:moriya_wih_attacker
            }
        }
        ai_chance = {
            factor = 100
            modifier = {
                factor = 0.5
                fleet_power < 25000
            }
            modifier = {
                factor = 0.5
                fleet_power < 50000
            }
            modifier = {
                factor = 2
                fleet_power > 80000
            }
            modifier = {
                factor = 2
                fleet_power > 100000
            }
            modifier = {
                factor = 2
                fleet_power > 125000
            }
            modifier = {
                factor = 2
                has_federation = yes
            }
            modifier = {
                factor = 3
                any_country = {
                    is_in_federation_with = root
                    NOT = {
                        is_same_value = event_target:moriya_wih_attacker
                    }
                    fleet_power > 100000
                }
            }
            modifier = {
                factor = 5
                any_country = {
                    is_ai = no
                    NOT = {
                        is_same_value = event_target:moriya_wih_attacker
                    }
                    is_in_federation_with = root
                }
            }
        }
    }
    option = {
        name = touhou_war_in_heaven.4.c.2
        trigger = {
            is_subject = no
        }
        ai_chance = {
            factor = 0
        }
    }
    option = {
        name = touhou_war_in_heaven.4.d
        trigger = {
            is_subject = yes
        }
        if = {
            limit = {
                overlord = { is_same_value = event_target:moriya_wih_attacker }
            }
            join_war = event_target:moriya_wih_attacker
        }
        if = {
            limit = {
                overlord = { is_same_value = event_target:moriya_wih_defender }
            }
            join_war = event_target:moriya_wih_defender
        }
    }
    after = {
        country_event = { id = timeline.76 } # Timeline War in Heaven
    }
}

# Victory for one side
country_event = {
    id = touhou_war_in_heaven.5
    title = touhou_war_in_heaven.5.name
    desc = {
        text = touhou_war_in_heaven.5.desc.moriya_victory
        trigger = {
            has_global_flag = moriya_won_moriya_wih
        }
    }
    desc = {
        text = touhou_war_in_heaven.5.desc.fallen_victory
        trigger = {
            has_global_flag = fallen_won_moriya_wih
        }
    }
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    trigger = {
        is_subject = no
    }

    option = {
        name = touhou_war_in_heaven.5.a
    }
}

# Ends in Status Quo
country_event = {
    id = touhou_war_in_heaven.6
    title = touhou_war_in_heaven.6.name
    desc = touhou_war_in_heaven.6.desc
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    option = {
        name = touhou_war_in_heaven.6.a
    }
}

# Event for Galactic Empire
country_event = {
    id = touhou_war_in_heaven.7
    title = touhou_war_in_heaven.4.name
    desc = {
        text = touhou_war_in_heaven.7.fallen
        trigger = {
            has_global_flag = moriya_war_in_heaven_vs_fallen
        }
    }
    desc = {
        text = touhou_war_in_heaven.7.awakened
        trigger = {
            has_global_flag = moriya_war_in_heaven_vs_awakened
        }
    }
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    immediate = {
        # End existing wars
        if = {
            limit = { is_at_war = yes }
            every_war = { remove_war_participant = prev }
        }
    }

    option = {
        name = war_in_heaven.7.a
        trigger = { is_galactic_emperor = yes }
        add_imperial_authority = 100
        custom_tooltip = war_in_heaven.7.tooltip
        hidden_effect = {
            every_country = {
                limit = {
                    OR = {
                        is_same_value = event_target:moriya_wih_attacker
                        is_same_value = event_target:moriya_wih_defender
                    }
                }
                declare_war = {
                    target = event_target:gal_emperor
                    name = "NAME_The_War_in_Heaven"
                    attacker_war_goal = "wg_war_in_heaven"
                }
                every_subject = {
                    join_war = prev
                    remove_from_galactic_community = yes
                }
            }
            every_playable_country = {
                limit = {
                    is_galactic_emperor = no
                    is_galactic_community_member = yes
                }
                join_war = event_target:gal_emperor
            }
        }
    }
    option = {
        name = war_in_heaven.7.b
        trigger = { is_galactic_emperor = no }
        custom_tooltip = war_in_heaven.7.tooltip
    }
}

# War in Heaven combatant defeated by any source
#This = destroyed country
#From = optional, destroyer (country)
country_event = {
    id = touhou_war_in_heaven.10
    title = OK
    desc = OK

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        OR = {
            is_same_value = event_target:moriya_wih_attacker
            is_same_value = event_target:moriya_wih_defender
        }
        any_war = {
            any_war_participant = {
                prev = { #The War
                    using_war_goal = {
                        type = wg_war_in_heaven
                        owner = prev #The War participant
                    }
                }
            }
            any_war_participant = {
                OR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
                prev = { #The War
                    OR = {
                        AND = {
                            is_war_participant = {
                                who = prev #The opposing Awakened Empire
                                side = attackers
                            }
                            is_war_participant = {
                                who = root #The dead Awakened Empire
                                side = defenders
                            }
                        }
                        AND = {
                            is_war_participant = {
                                who = prev #The opposing Awakened EMpire
                                side = defenders
                            }
                            is_war_participant = {
                                who = root #The dead Awakened Empire
                                side = attackers
                            }
                        }
                    }
                }
            }
        }
        has_global_flag = war_in_heaven_ongoing
        OR = {
            NOT = { exists = from }
            from = {
                NOR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
            }
        }
    }

    immediate = {
        set_global_flag = war_in_heaven_first_awakened_down

        random_country = {
            limit = {
                OR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
                NOT = { is_same_value = root }
                any_war = {
                    any_war_participant = {
                        prev = { #The War
                            using_war_goal = {
                                type = wg_war_in_heaven
                                owner = prev #The Participant
                            }
                        }
                    }
                }
            }
            save_event_target_as = RemainingAwakened
        }

        every_war = { #End War in Heaven
            limit = {
                any_war_participant = {
                    prev = { #The war we are iterating through
                        using_war_goal = {
                            type = wg_war_in_heaven
                            owner = prev #The participant
                        }
                    }
                }
            }
            end_war_effect = yes
        }
        set_global_flag = war_in_heaven_first_awakened_down

        if = {
            limit = {
                NOT = {
                    any_country = {
                        any_war = {
                            using_war_goal = {
                                type = wg_war_in_heaven
                                owner = prev
                            }
                        }
                    }
                }
            }
            remove_global_flag = war_in_heaven_ongoing
            set_global_flag = war_in_heaven_ended
        }
        every_country = {
            limit = { is_ai = no }
            country_event = { id = touhou_war_in_heaven.11 }
        }
        observer_event = { id = observer.79 }
    }
}

country_event = {
    id = touhou_war_in_heaven.11
    title = touhou_war_in_heaven.11.name
    desc = touhou_war_in_heaven.11.desc
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    option = {
        name = touhou_war_in_heaven.11.a
    }
}

# Find a leader for non-aligned league of empires
country_event = {
    id = touhou_war_in_heaven.12
    title = OK
    desc = OK

    hide_window = yes

    is_triggered_only = yes

    trigger = {
        is_same_value = event_target:moriya_wih_attacker
        has_global_flag = war_in_heaven_ongoing
        NOT = { has_global_flag = war_in_heaven_nonaligned_league }
        NOT = { has_global_flag = war_in_heaven_seeking_league_leader }
        has_galactic_emperor = no # Galactic Empire serves this purpose
        any_country = {
            is_subject = no
            NOT = {
                any_country = {
                    OR = {
                        is_same_value = event_target:moriya_wih_attacker
                        is_same_value = event_target:moriya_wih_defender
                    }
                    is_at_war_with = prev
                }
            }
            is_country_type = default

            any_country = {
                is_subject = no
                is_country_type = default
                NOR = {
                    any_country = {
                        OR = {
                            is_same_value = event_target:moriya_wih_attacker
                            is_same_value = event_target:moriya_wih_defender
                        }
                        is_at_war_with = prev
                    }
                    is_homicidal = yes
                    is_level_4_player_crisis = yes
                    is_level_5_player_crisis = yes
                    has_country_flag = war_in_heaven_league_leader_declined
                    is_same_value = prev
                }
            }
        }
    }

    immediate = {
        # Custodian is asked first, if one exists
        if = {
            limit = {
                has_galactic_custodian = yes
                any_playable_country = {
                    is_galactic_custodian = yes
                    NOT = {
                        has_country_flag = war_in_heaven_league_leader_declined
                        any_country = {
                            OR = {
                                is_same_value = event_target:moriya_wih_attacker
                                is_same_value = event_target:moriya_wih_defender
                            }
                            is_at_war_with = prev
                        }
                    }
                }
            }
            random_playable_country = {
                limit = {
                    is_galactic_custodian = yes
                    NOT = {
                        has_country_flag = war_in_heaven_league_leader_declined
                        any_country = {
                            OR = {
                                is_same_value = event_target:moriya_wih_attacker
                                is_same_value = event_target:moriya_wih_defender
                            }
                            is_at_war_with = prev
                        }
                    }
                }
                set_global_flag = war_in_heaven_seeking_league_leader
                country_event = { id = touhou_war_in_heaven.13 }
            }
        }
        # Find strongest neutral power and offer them to become league leader
        # First federation leaders are asked, then simply the strongest country
        else_if = {
            limit = {
                any_federation = {
                    NOR = {
                        has_global_flag = war_in_heaven_seeking_league_leader
                        has_federation_flag = hive_fe_federation
                    }
                    any_member = {
                        is_federation_leader = yes
                        is_homicidal = no
                        NOR = {
                            has_country_flag = war_in_heaven_league_leader_declined
                            any_country = {
                                OR = {
                                    is_same_value = event_target:moriya_wih_attacker
                                    is_same_value = event_target:moriya_wih_defender
                                }
                                is_at_war_with = prev
                            }
                        }
                    }
                    NOT = {
                        any_federation = {
                            NOT = { is_same_value = prev }
                            relative_power = {
                                who = prev
                                value > equivalent
                                category = fleet
                            }
                            any_member = {
                                is_federation_leader = yes
                                is_homicidal = no
                                NOR = {
                                    has_country_flag = war_in_heaven_league_leader_declined
                                    has_ascension_perk = ap_become_the_crisis
                                    any_country = {
                                        OR = {
                                            is_same_value = event_target:moriya_wih_attacker
                                            is_same_value = event_target:moriya_wih_defender
                                        }
                                        is_at_war_with = prev
                                    }
                                }
                            }
                        }
                    }
                }
            }
            random_federation = {
                limit = {
                    NOR = {
                        has_global_flag = war_in_heaven_seeking_league_leader
                        has_federation_flag = hive_fe_federation
                    }
                    any_member = {
                        is_federation_leader = yes
                        is_homicidal = no
                        NOR = {
                            has_country_flag = war_in_heaven_league_leader_declined
                            is_level_4_player_crisis = yes
                            is_level_5_player_crisis = yes
                            any_country = {
                                OR = {
                                    is_same_value = event_target:moriya_wih_attacker
                                    is_same_value = event_target:moriya_wih_defender
                                }
                                is_at_war_with = prev
                            }
                        }
                    }
                    NOT = {
                        any_federation = {
                            NOT = { is_same_value = prev }
                            relative_power = {
                                who = prev
                                value > equivalent
                                category = fleet
                            }
                            any_member = {
                                is_federation_leader = yes
                                is_homicidal = no
                                NOR = {
                                    has_country_flag = war_in_heaven_league_leader_declined
                                    has_ascension_perk = ap_become_the_crisis
                                    any_country = {
                                        OR = {
                                            is_same_value = event_target:moriya_wih_attacker
                                            is_same_value = event_target:moriya_wih_defender
                                        }
                                        is_at_war_with = prev
                                    }
                                }
                            }
                        }
                    }
                }
                random_member = {
                    limit = {
                        is_federation_leader = yes
                        is_homicidal = no
                        NOR = {
                            has_country_flag = war_in_heaven_league_leader_declined
                            is_level_4_player_crisis = yes
                            is_level_5_player_crisis = yes
                            any_country = {
                                OR = {
                                    is_same_value = event_target:moriya_wih_attacker
                                    is_same_value = event_target:moriya_wih_defender
                                }
                                is_at_war_with = prev
                            }
                        }
                    }
                    set_global_flag = war_in_heaven_seeking_league_leader
                    country_event = { id = touhou_war_in_heaven.13 }
                }
            }
        }

        else = {
            random_country = {
                limit = {
                    is_subject = no
                    NOT = {
                        any_country = {
                            OR = {
                                is_same_value = event_target:moriya_wih_attacker
                                is_same_value = event_target:moriya_wih_defender
                            }
                            is_at_war_with = prev
                        }
                    }
                    is_country_type = default
                    NOR = {
                        is_homicidal = yes
                        is_level_4_player_crisis = yes
                        is_level_5_player_crisis = yes
                        has_global_flag = war_in_heaven_seeking_league_leader
                        has_country_flag = war_in_heaven_league_leader_declined
                        any_country = {
                            is_country_type = default
                            relative_power = {
                                who = prev
                                value > equivalent
                            }
                            is_subject = no
                            NOR = {
                                any_country = {
                                    OR = {
                                        is_same_value = event_target:moriya_wih_attacker
                                        is_same_value = event_target:moriya_wih_defender
                                    }
                                    is_at_war_with = prev
                                }
                                is_homicidal = yes
                                is_level_4_player_crisis = yes
                                is_level_5_player_crisis = yes
                                has_country_flag = war_in_heaven_league_leader_declined
                            }
                        }
                    }
                }
                set_global_flag = war_in_heaven_seeking_league_leader
                country_event = { id = touhou_war_in_heaven.13 }
            }
        }
    }
}

country_event = {
    id = touhou_war_in_heaven.13
    title = touhou_war_in_heaven.13.name
    desc = {
        text = touhou_war_in_heaven.13.desc
        trigger = {
            is_galactic_custodian = no
            OR = {
                has_federation = no
                is_federation_leader = no
            }
        }
    }
    desc = {
        text = touhou_war_in_heaven.13.desc2
        trigger = {
            is_galactic_custodian = no
            has_federation = yes
            is_federation_leader = yes
        }
    }
    desc = {
        text = touhou_war_in_heaven.13.desc3
        trigger = { is_galactic_custodian = yes }
    }
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = root

    is_triggered_only = yes

    immediate = {
        set_country_flag = war_in_heaven_nonaligned_league_check
    }

    option = {
        name = touhou_war_in_heaven.13.a
        ai_chance = {
            factor = 100
        }
        if = {
            limit = { #existing federation will become the Non-Aligned League
                has_federation = yes
                is_federation_leader = yes
            }
            federation = {
                set_name = NAME_League_of_Non-Aligned_Powers
                set_federation_flag = non_aligned_league
            }
            hidden_effect = {
                set_country_flag = formed_nonaligned_league
                every_country = {
                    limit = {
                        is_ai = yes
                        is_in_federation_with = root
                        NOT = { is_same_value = root }
                    }
                    set_country_flag = war_in_heaven_nonaligned_league_check
                    add_non_aligned_league_opinions = yes
                    set_timed_country_flag = { flag = ai_no_leave_fed days = 7200 }
                }
            }
        }
        else_if = {
            limit = { has_federation = yes }
            leave_alliance = {
                override_requirements = yes
            }
        }
        hidden_effect = {
            set_timed_country_flag = { flag = war_in_heaven_nonaligned_league_timer days = 180 }
            country_event = {
                id = touhou_war_in_heaven.16
                days = 180
            }
            set_country_flag = war_in_heaven_league_leader
            set_global_flag = war_in_heaven_nonaligned_league
            remove_global_flag = war_in_heaven_seeking_league_leader
            every_country = {
                limit = {
                    OR = {
                        is_same_value = event_target:moriya_wih_attacker
                        is_same_value = event_target:moriya_wih_defender
                    }
                }
                add_opinion_modifier = { who = root modifier = opinion_non_aligned_league_fe }
                root = { add_opinion_modifier = { who = prev modifier = opinion_non_aligned_league_fe } }
            }

            every_playable_country = {
                limit = {
                    is_ai = no
                    is_homicidal = no
                    OR = {
                        is_subject = no
                        is_in_federation_with = root
                    }
                    NOR = {
                        is_same_value = root
                        has_country_flag = war_in_heaven_nonaligned_league_check
                        is_same_value = event_target:moriya_wih_attacker
                    }
                }
                country_event = { id = touhou_war_in_heaven.19 }
            }
            every_playable_country = {
                limit = {
                    is_ai = no
                    OR = {
                        NOR = {
                            is_in_federation_with = root
                            is_same_value = root
                            has_country_flag = war_in_heaven_nonaligned_league_check
                        }
                        is_same_value = event_target:moriya_wih_attacker
                    }
                }
                country_event = { id = touhou_war_in_heaven.22 }
            }
        }
    }
    option = {
        name = touhou_war_in_heaven.13.b
        ai_chance = {
            factor = 1
        }
        hidden_effect = {
            set_country_flag = war_in_heaven_league_leader_declined
            remove_global_flag = war_in_heaven_seeking_league_leader
        }
    }
}

# AI will try to join the League if it can
country_event = {
    id = touhou_war_in_heaven.14

    hide_window = yes

    is_triggered_only = yes

    trigger = {
        is_country_type = default
        has_global_flag = war_in_heaven_nonaligned_league
        NOT = { has_country_flag = war_in_heaven_nonaligned_league_check }
        is_subject = no
        NOT = {
            any_country = {
                OR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
                is_at_war_with = prev
            }
        }
        is_homicidal = no
        is_ai = yes
        any_country = {
            has_country_flag = war_in_heaven_league_leader
            has_country_flag = war_in_heaven_nonaligned_league_timer
            OR = {
                has_federation = yes
                NOT = { has_country_flag = formed_nonaligned_league }
            }
            is_subject = no
            is_country_type = default
            NOT = { is_in_federation_with = root }
        }
    }

    immediate = {
        set_country_flag = war_in_heaven_nonaligned_league_check
        random_country = {
            limit = {
                has_country_flag = war_in_heaven_league_leader
                is_subject = no
                is_country_type = default
            }
            country_event = { id = touhou_war_in_heaven.15 }
        }
    }
}

country_event = {
    id = touhou_war_in_heaven.15
    title = touhou_war_in_heaven.15.name
    desc = touhou_war_in_heaven.15.desc
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    OR = {
                        is_same_value = event_target:moriya_wih_attacker
                        is_same_value = event_target:moriya_wih_defender
                    }
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                OR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    trigger = {
        OR = {
            has_federation = yes
            NOT = { has_country_flag = formed_nonaligned_league }
        }
    }

    option = {
        name = touhou_war_in_heaven.15.a
        ai_chance = {
            factor = 100
        }
        if = {
            limit = {
                NOT = { has_country_flag = formed_nonaligned_league }
            }
            set_country_flag = formed_nonaligned_league
        }
        hidden_effect = {
            from = {
                if = {
                    limit = { has_federation = yes }
                    leave_alliance = {
                        override_requirements = yes
                    }
                }
                add_non_aligned_league_opinions = yes
                if = {
                    limit = { is_ai = no }
                    country_event = { id = touhou_war_in_heaven.20 }
                }
            }
        }
        if = {
            limit = { has_federation = no }
            from = {
                set_timed_country_flag = { flag = ai_no_leave_fed days = 7200 }
                join_alliance = {
                    who = root
                    name = NAME_League_of_Non-Aligned_Powers
                    override_requirements = yes
                }
                hidden_effect = {
                    if = { #end non-federation-sanctioned wars
                        limit = {
                            is_at_war = yes
                        }
                        every_war = {
                            remove_war_participant = prev
                        }
                        every_subject = {
                            every_war = {
                                remove_war_participant = prev
                            }
                        }
                    }
                    root.federation = {
                        set_federation_flag = non_aligned_league
                        if = {
                            limit = {
                                has_federation_perk = cohesion_join_1
                            }
                            add_cohesion = 50
                        }
                        else = { add_cohesion = 100 }
                        add_federation_experience = 4200 #level 3 with some breathing room
                    }
                }
            }
        }
        else = {
            from = {
                set_timed_country_flag = { flag = ai_no_leave_fed days = 7200 }
                hidden_effect = { #end rivalries, wars
                    if = {
                        limit = {
                            any_rival_country = {
                                has_federation = yes
                                federation = {
                                    is_same_value = root.federation
                                }
                            }
                        }
                        every_rival_country = {
                            limit = {
                                has_federation = yes
                                federation = {
                                    is_same_value = root.federation
                                }
                            }
                            prev = { end_rivalry = prev }
                        }
                    }
                    root.federation = {
                        if = {
                            limit = {
                                any_member = {
                                    is_rival = prevprev
                                }
                            }
                            every_member = {
                                limit = {
                                    is_rival = prevprev
                                }
                                end_rivalry = prevprev
                            }
                        }
                    }
                    if = {
                        limit = {
                            is_at_war = yes
                        }
                        every_war = {
                            remove_war_participant = prev
                        }
                    }
                }
                join_alliance = {
                    who = root
                    override_requirements = yes
                }
                hidden_effect = {
                    root.federation = {
                        if = { #counteract the -100 cohesion you'd normally get for new members
                            limit = {
                                has_federation_perk = cohesion_join_1
                            }
                            add_cohesion = 50
                        }
                        else = { add_cohesion = 100 }
                        add_federation_experience = 150
                    }
                }
                if = {
                    limit = {
                        is_overlord = yes
                        root.federation = {
                            has_federation_law = allow_subjects_to_join_yes
                        }
                    }
                    every_subject = {
                        root = {
                            prev = { add_non_aligned_league_opinions = yes }
                        }
                        join_alliance = {
                            who = root
                            override_requirements = yes
                        }
                        hidden_effect = {
                            root.federation = {
                                add_cohesion = 100
                                add_federation_experience = 100
                            }
                        }
                    }
                }
            }
        }
    }
    option = {
        name = touhou_war_in_heaven.15.b
        ai_chance = {
            factor = 1
        }
        hidden_effect = {
            from = { add_opinion_modifier = { who = root modifier = opinion_non_aligned_league_declined } }
            from = {
                if = {
                    limit = { is_ai = no }
                    country_event = { id = touhou_war_in_heaven.21 }
                }
            }
        }
    }
}

country_event = {
    id = touhou_war_in_heaven.16
    title = touhou_war_in_heaven.16.name
    desc = touhou_war_in_heaven.16.desc
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = root

    is_triggered_only = yes

    trigger = {
        has_federation = yes
        is_federation_leader = yes
        federation = {
            has_federation_flag = non_aligned_league
        }
        has_global_flag = war_in_heaven_nonaligned_league
        NOR = {
            has_global_flag = war_in_heaven_nonaligned_league_war
            any_country = {
                OR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
                is_at_war_with = prev
            }
        }
        any_country = {
            is_same_value = event_target:moriya_wih_attacker
        }
        any_country = {
            is_same_value = event_target:moriya_wih_defender
        }
    }

    immediate = {
        set_global_flag = war_in_heaven_nonaligned_league_war
    }

    option = {
        name = touhou_war_in_heaven.16.a

        every_country = {
            limit = {
                OR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
            }
            declare_war = {
                target = root
                name = "NAME_The_War_in_Heaven"
                attacker_war_goal = "wg_war_in_heaven"
            }
            hidden_effect = {
                every_subject = {
                    join_war = prev
                }
            }
        }
    }
}

# War in Heaven ends because both Awakened Empires are gone
country_event = {
    id = touhou_war_in_heaven.17
    title = OK
    desc = OK

    hide_window = yes
    is_triggered_only = yes

    trigger = {
        OR = {
            is_same_value = event_target:moriya_wih_attacker
            is_same_value = event_target:moriya_wih_defender
        }
        has_global_flag = war_in_heaven_ongoing
        NOT = {
            any_country = {
                is_at_war_with = root
                OR = {
                    is_same_value = event_target:moriya_wih_attacker
                    is_same_value = event_target:moriya_wih_defender
                }
            }
        }
    }


    immediate = {
        if = {
            limit = {
                any_war = {
                    any_war_participant = {
                        prev = {
                            using_war_goal = {
                                type = wg_war_in_heaven
                                owner = prev
                            }
                        }
                    }
                }
            }
            every_war = { #End War in Heaven
                limit = {
                    any_war_participant = {
                        prev = {
                            using_war_goal = {
                                type = wg_war_in_heaven
                                owner = prev
                            }
                        }
                    }
                }
                end_war_effect = yes
            }
        }
        if = {
            limit = {
                NOT = { has_global_flag = war_in_heaven_ended }
            }
            remove_global_flag = war_in_heaven_ongoing
            set_global_flag = war_in_heaven_ended
            random_federation = {
                limit = {
                    has_federation_flag = non_aligned_league
                }
                add_modifier = {
                    modifier = war_in_heaven_is_over
                    days = -1
                }
                random_member = {
                    limit = {
                        is_federation_leader = yes
                    }
                    set_country_flag = last_best_hope
                }
            }
            every_country = {
                limit = { is_ai = no }
                country_event = { id = touhou_war_in_heaven.18 }
            }
            observer_event = { id = observer.80 }
        }
    }
}

country_event = {
    id = touhou_war_in_heaven.18
    title = touhou_war_in_heaven.18.name
    desc = touhou_war_in_heaven.18.desc
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    option = {
        name = touhou_war_in_heaven.18.a
    }
}

country_event = {
    id = touhou_war_in_heaven.19
    title = touhou_war_in_heaven.19.name
    desc = {
        text = touhou_war_in_heaven.19.desc
        trigger = {
            from = { has_federation = no }
        }
    }
    desc = {
        text = touhou_war_in_heaven.19.desc3
        trigger = {
            from = { has_federation = yes }
            NOT = { is_in_federation_with = from }
        }
    }
    desc = {
        text = touhou_war_in_heaven.19.desc2
        trigger = {
            is_in_federation_with = from
        }
    }
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    immediate = {
        set_country_flag = war_in_heaven_nonaligned_league_check
    }

    option = {
        name = touhou_war_in_heaven.19.a
        trigger = {
            NOT = { is_in_federation_with = from }
        }
        hidden_effect = {
            from = {
                country_event = { id = touhou_war_in_heaven.15 }
            }
        }
    }
    option = {
        trigger = {
            is_in_federation_with = from
        }
        name = touhou_war_in_heaven.19.a2
        hidden_effect = {
            from = { #this weird scoping is necessary for the scopes in the scripted effect
                root = {
                    add_non_aligned_league_opinions = yes
                }
            }
        }
    }
    option = {
        trigger = {
            NOT = { is_in_federation_with = from }
        }
        name = touhou_war_in_heaven.19.b
    }
    option = {
        trigger = {
            is_in_federation_with = from
            is_subject = no
        }
        name = touhou_war_in_heaven.19.b2
        leave_alliance = {
            override_requirements = yes
        }
        ai_chance = {
            factor = 0
        }
    }
}

country_event = {
    id = touhou_war_in_heaven.20
    title = touhou_war_in_heaven.20.name
    desc = touhou_war_in_heaven.20.desc
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    option = {
        name = touhou_war_in_heaven.20.a
    }
}

country_event = {
    id = touhou_war_in_heaven.21
    title = touhou_war_in_heaven.21.name
    desc = touhou_war_in_heaven.21.desc
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    option = {
        name = touhou_war_in_heaven.21.a
    }
}

country_event = {
    id = touhou_war_in_heaven.22
    title = touhou_war_in_heaven.22.name
    desc = {
        text = touhou_war_in_heaven.22.desc
        trigger = {
            from = { has_federation = no }
        }
    }
    desc = {
        text = touhou_war_in_heaven.22.desc2
        trigger = {
            from = { has_federation = yes }
        }
    }
    picture = {
        trigger = {
            NOT = {
                any_country = {
                    is_country_type = awakened_fallen_empire
                    is_hive_empire = yes
                }
            }
        }
        picture = GFX_evt_fallen_empire_awakes
    }

    picture = {
        trigger = {
            any_country = {
                is_country_type = awakened_fallen_empire
                is_hive_empire = yes
            }
        }
        picture = GFX_evt_hive_mind_fallen_empire
    }
    show_sound = event_alien_signal
    location = from

    is_triggered_only = yes

    immediate = {
        set_country_flag = war_in_heaven_nonaligned_league_check
    }

    option = {
        trigger = {
            NOT = {
                is_same_value = event_target:moriya_wih_attacker
            }
        }
        name = touhou_war_in_heaven.22.a
    }
    option = {
        trigger = {
            is_same_value = event_target:moriya_wih_attacker
        }
        name = touhou_war_in_heaven.22.b
    }
}
